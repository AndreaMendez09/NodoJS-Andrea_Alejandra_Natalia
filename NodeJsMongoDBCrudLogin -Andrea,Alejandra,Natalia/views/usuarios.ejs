<% include partials/_header %>

<head>
  <meta charset="utf-8">
  <title>Usuarios</title>
  <!-- BOOTSTRAP CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
    integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
</head>
<%if(user.rol == "Administrador"){%>
<div class="container">
  <div class="row">
    <div class="col-md-10">
      <div class="card">
        <div class="card-body">
          <form action="/usuarios/add" method="post" enctype="multipart/form-data">
            <div class="form-group">
              <input class="form-control" type="text" name="nombre" placeholder="Nombre" required>
            </div>
            <div class="form-group">
              <input class="form-control" type="text" name="apellidos" placeholder="Apellidos" required>
            </div>
            <div class="form-group">
              <input class="form-control" type="text" name="correo" placeholder="Correo" required>
            </div>
            <div class="form-group">
              <input class="form-control" type="text" name="password" placeholder="Contraseña" required>
            </div>
            <div class="form-group">
              <input class="form-control" type="text" name="imagen" placeholder="Introduce una url con foto">
            </div>
            <div>
              <label>Rol:</label>
              <select name="rol" onchange="alCambiar()" id="tipo">
                <option>Administrador</option>
                <option>Profesor</option>
                <option>Alumno</option>
              </select>
            </div>



            <div id="tipoEstudio" style="display: none;">
              <label>Tipo de curso:</label>
              <select name="tipo_curso" id="selectEstudio" onchange="tipoCurso()" >
                <option value="none" selected disabled hidden>Selecciona una opcion</option>
                <option value="Grado">Grado</option>
                <option value="Master">Master</option>
                <option value="Doctorado">Doctorado</option>
              </select>
            </div>

            <script>
              function alCambiar() {
                var rol_seleccionado = $('#tipo').val();
                //let tuSitioCheckbox = $("#asignatura_box");
                //tuSitioCheckbox.prop("checked", !tuSitioCheckbox.prop("checked"));
                if (rol_seleccionado == "Alumno") {
                  $("#tipoEstudio").show();
                  $("#solo_grado").hide();
                  $("#todas").hide();
                  $("#solo_master").hide();
                  $("#solo_doctorado").hide();
                } else {
                  //$("#tipoEstudio").selectedIndex=1;
                  $("#tipoEstudio").hide();
                  $("#todas").show();
                  $("#solo_master").hide();
                  $("#solo_doctorado").hide();
                  $("#solo_grado").hide();               
                }
              }

              function tipoCurso() {
                var curso_seleccionado = $('#selectEstudio').val();
                var rol_seleccionado = $('#tipo').val();


                if (rol_seleccionado != "Alumno") {
                  $("#todas").show();
                  $("#solo_master").hide();
                  $("#solo_doctorado").hide();
                  $("#solo_grado").hide();
                }
                if (curso_seleccionado == "Grado") {
                  $("#solo_grado").show();
                  $("#todas").hide();
                  $("#solo_master").hide();
                  $("#solo_doctorado").hide();
                } else if (curso_seleccionado == "Master"){
                  $("#solo_grado").hide();
                  $("#todas").hide();
                  $("#solo_master").show();
                  $("#solo_doctorado").hide();
                } else if (curso_seleccionado == "Doctorado") {
                  $("#solo_grado").hide();
                  $("#todas").hide();
                  $("#solo_master").hide();
                  $("#solo_doctorado").show();
                }
              }
            </script>


            <br>
            <div class="form-group" id="todas">
              <label>Asignaturas: </label>
              <%for (var i=0; i < asignaturas.length;i++){%>
              <input type="checkbox" name="asignaturas" value="<%=asignaturas[i]._id%>" id="asignatura_box">
              <label for="asignaturas"><%=asignaturas[i].title%></label>
              <% } %>
            </div>
            <div class="form-group" id="solo_grado" style="display: none;">
              <label>Asignaturas de grado: </label>
              <%for (var i=0; i < asignaturas.length;i++){%>
              <% if (asignaturas[i].tipo_asignatura == "Grado") {%>
              <input type="checkbox" name="asignaturas" value="<%=asignaturas[i]._id%>">
              <label for="asignaturas"><%=asignaturas[i].title%></label>
              <% } %>
              <% } %>
            </div>
            <div class="form-group" id="solo_master" style="display: none;">
              <label>Asignaturas de master: </label>
              <%for (var i=0; i < asignaturas.length;i++){%>
              <% if (asignaturas[i].tipo_asignatura == "Master") {%>
              <input type="checkbox" name="asignaturas" value="<%=asignaturas[i]._id%>">
              <label for="asignaturas"><%=asignaturas[i].title%></label>
              <% } %>
              <% } %>
            </div>
            <div class="form-group" id="solo_doctorado" style="display: none;">
              <label>Asignaturas de doctorado: </label>
              <%for (var i=0; i < asignaturas.length;i++){%>
              <% if (asignaturas[i].tipo_asignatura == "Doctorado") {%>
              <input type="checkbox" name="asignaturas" value="<%=asignaturas[i]._id%>">
              <label for="asignaturas"><%=asignaturas[i].title%></label>
              <% } %>
              <% } %>
            </div>
            <button class="btn btn-secondary" type="submit">Añadir</button>
          </form>
        </div>
      </div>
      <br>
      <br>
    </div>

    <div class="form-group">
      <form method="post" enctype="multipart/form-data" action="/addUserCSV">

        <p>
          <input type="file" name="file" accept="text/CSV" />
          <button type="submit">Añadir mediante CSV</button>
        </p>

      </form>
    </div>

    <div class="col-md-20">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>N°</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Correo</th>
            <th>Rol</th>
            <th>Tipo de curso</th>
            <th>Asignaturas</th>
            <th>Operaciones</th>

          </tr>
        </thead>
        <tbody>
          <% for(var i=0; i < usuarios.length; i++) { %>
          <tr>
            <td><%= i + 1%></td>
            <td><%= usuarios[i].nombre%></td>
            <td><%= usuarios[i].apellidos%></td>
            <td><%= usuarios[i].correo%></td>
            <td><%= usuarios[i].rol%></td>
            <td><%= usuarios[i].tipo_curso%></td>
            <td>
              <%for (var j=0; j < usuarios[i].asignaturas.length;j++){%>
              <%for (var k=0;k < asignaturas.length;k++){%>

              <%if(asignaturas[k]._id.toString()==usuarios[i].asignaturas[j].toString()){%>
              <%= asignaturas[k].title%>
              <% } %>
              <% } %>
              <% } %>
            </td>
            <td>

              <a href="/usuarios/editar_usuarios/<%= usuarios[i]._id %>" class="btn btn-secondary">Edit</a>
              <a id="eliminar" onclick="pop_up()" href="/usuarios/delete/<%= usuarios[i]._id %>"
                class="btn btn-danger">Delete</a>
            </td>
          </tr>
          <% } %>
        </tbody>
      </table>

    </div>
  </div>
</div>
<script language="javascript" type="text/javascript">
  // Dependiendo del usuario, se mostrará las asignaturas que podrá matricular. Esto lo puede hacer el alumno y el
  // profesor. El administrador no, ya que se encarga de administrar todo el campus.
  $(document).ready(function () {
    $("#tipoEstudio").show();
    $("#tipo").change(function () {
      // Si seleccionamos uno de estos dois usuarios, se muestrán las asignaturas
      if ($('#tipo').val() == "Alumno") {
        $("#tipoEstudio").show();
        // En caso contrario, se oculta.
      } else {
        $("#tipoEstudio").hide();
      }
    });
  });

  //No va el scrip nose sabe porque

  function pop_up() {
    var elemento = document.getElementById("eliminar");
    if (confirm("¿Estas seguro de que quieres eliminar?")) {
      var hola;
    } else {
      elemento.setAttribute("href", "/usuarios");
    }
  }
</script>
<%}%>
<% include partials/_footer %>